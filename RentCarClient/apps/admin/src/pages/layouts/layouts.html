<!-- eslint-disable @angular-eslint/template/click-events-have-key-events -->
<!-- eslint-disable @angular-eslint/template/interactive-supports-focus -->

<!-- Sidebar -->
<nav class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-brand">
      <i class="bi bi-car-front-fill"></i>
      <span class="brand-text">RentCar</span>
      <span class="admin-badge">Admin</span>
    </div>
  </div>

  <div class="sidebar-content">
    <ul class="sidebar-menu">
      @for (nav of navigations(); track nav.title) { @if (!nav.haveSubNav &&
      checkPermission(nav.permission)) {
      <li
        [routerLink]="nav.url"
        routerLinkActive="active"
        [routerLinkActiveOptions]="{ exact: nav.url === '/' }"
        class="menu-item"
      >
        <a class="menu-link">
          <i class="bi" [ngClass]="nav.icon"></i>
          <span class="menu-text"
            >{{nav.translationKey ? (nav.translationKey | translate) :
            nav.title}}</span
          >
        </a>
      </li>
      } @else if(checkPermission(nav.permission)) {
      <li class="menu-item">
        <a class="menu-link">
          <i class="bi" [ngClass]="nav.icon"></i>
          <span class="menu-text"
            >{{nav.translationKey ? (nav.translationKey | translate) :
            nav.title}}</span
          >
          <i class="bi bi-chevron-right menu-arrow"></i>
        </a>
        <ul class="submenu">
          @for (subNav of nav.subNavs; track subNav.title) { @if
          (checkPermission(subNav.permission)) {
          <li>
            <a [routerLink]="subNav.url"
              >{{subNav.translationKey ? (subNav.translationKey | translate) :
              subNav.title}}</a
            >
          </li>
          } }
        </ul>
      </li>
      } }
    </ul>
  </div>

  <div class="sidebar-footer">
    <div class="user-info">
      <div class="user-avatar">
        <img
          src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRNBRW6kw4PvewS5EGHKY7nNsJiWvrbsVIzZA&s"
          alt="Admin"
        />
      </div>
      <div class="user-details">
        <span class="user-name">{{decode().fullName}}</span>
        <span class="user-role">{{decode().branch}}</span>
      </div>
    </div>
  </div>
</nav>

<!-- Main Wrapper -->
<div class="main-wrapper">
  <!-- Top Navbar -->
  <header class="navbar-custom">
    <div class="navbar-content">
      <!-- Left Side - Breadcrumb -->
      <div class="navbar-left">
        <button class="mobile-sidebar-toggle d-lg-none">
          <i class="bi bi-list"></i>
        </button>
        <nav aria-label="breadcrumb">
          <app-breadcrumb />
        </nav>
      </div>

      <!-- Right Side - Language Toggle & Profile -->
      <div class="navbar-right">
        <!-- Language Toggle Button -->
        <div class="language-toggle me-3">
          <button
            type="button"
            class="btn btn-outline-secondary btn-sm"
            (click)="toggleLanguage()"
            [title]="'Switch to ' + nextLanguageName()"
          >
            <i class="bi bi-translate me-1"></i>
            {{ getCurrentLanguage()?.code?.toUpperCase() }}
          </button>
        </div>

        <!-- Profile Dropdown -->
        <div class="profile-dropdown">
          <button class="profile-btn" data-bs-toggle="dropdown">
            <img
              src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRNBRW6kw4PvewS5EGHKY7nNsJiWvrbsVIzZA&s"
              alt="Profile"
              class="profile-avatar"
            />
            <span class="layout-profile-name">{{decode().fullName}}</span>
            <i class="bi bi-chevron-down"></i>
          </button>
          <ul class="dropdown-menu profile-menu">
            <li class="profile-header">
              <div class="profile-info">
                <img
                  src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRNBRW6kw4PvewS5EGHKY7nNsJiWvrbsVIzZA&s"
                  alt="Profile"
                />
                <div>
                  <h6>{{decode().fullName}}</h6>
                  <p>{{decode().email}}</p>
                  <span class="role-badge">{{decode().role}}</span>
                </div>
              </div>
            </li>
            <li>
              <hr class="dropdown-divider" />
            </li>
            <li>
              <a class="dropdown-item" href="#">
                <i class="bi bi-person"></i>
                {{ 'profile.my-profile' | translate }}
              </a>
            </li>
            <li>
              <a class="dropdown-item">
                <i class="bi bi-gear"></i>
                {{ 'profile.account-settings' | translate }}
              </a>
            </li>
            <li>
              <a class="dropdown-item" (click)="openSettingsPopup()">
                <i class="bi bi-shield-check"></i>
                {{ 'profile.security' | translate }}
              </a>
            </li>
            <li>
              <hr class="dropdown-divider" />
            </li>
            <li>
              <a class="dropdown-item" href="#">
                <i class="bi bi-question-circle"></i>
                {{ 'profile.help-support' | translate }}
              </a>
            </li>
            <li>
              <hr class="dropdown-divider" />
            </li>
            <li>
              <a
                class="dropdown-item text-danger"
                (click)="logout()"
                tabindex="0"
                (keyup)="($event.key === 'Enter' || $event.key === ' ') && logout()"
              >
                <i class="bi bi-box-arrow-right"></i>
                {{ 'profile.logout' | translate }}
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <div class="content-wrapper">
      <router-outlet />
    </div>
  </main>
</div>

<flexi-popup
  [(isPopupVisible)]="isSettingsPopupVisible"
  [loading]="isSettingsPopupLoading()"
  [showActionButtons]="false"
  popupTitle="{{ 'security.title' | translate }}"
  height="200px"
>
  <div class="p-3">
    <!-- TFA Settings -->
    <div class="mb-4">
      <div class="form-check form-switch mb-3">
        <input
          class="form-check-input"
          type="checkbox"
          id="tfaEnabled"
          [checked]="localTfaStatus()"
          [disabled]="isSettingsPopupLoading()"
          (change)="onTfaCheckboxChange($event)"
        />
        <label class="form-check-label" for="tfaEnabled">
          <strong>İki Adımlı Doğrulama</strong>
        </label>
      </div>

      <p class="text-muted small mb-3">
        İki adımlı doğrulama hesabınız için ek bir güvenlik katmanı sağlar. @if
        (localTfaStatus()) { Etkinleştirildiğinde, giriş yaparken telefon
        numaranıza gönderilen kodu girmeniz gerekecek. } @else { Devre dışı
        bırakıldığında, sadece kullanıcı adı ve şifre ile giriş yapabilirsiniz.
        }
      </p>
    </div>

    <!-- Action Buttons -->
    <div class="d-flex gap-2 justify-content-end">
      @if (hasUnsavedChanges()) {
      <button
        type="button"
        class="btn btn-outline-secondary"
        [disabled]="isSettingsPopupLoading()"
        (click)="resetTfaSettings()"
      >
        <i class="bi bi-arrow-counterclockwise me-1"></i>
        İptal Et
      </button>

      <button
        type="button"
        class="btn btn-primary"
        [disabled]="isSettingsPopupLoading()"
        (click)="saveTfaSettings()"
      >
        @if (isSettingsPopupLoading()) {
        <span
          class="spinner-border spinner-border-sm me-1"
          role="status"
          aria-hidden="true"
        ></span>
        } @else {
        <i class="bi bi-check-lg me-1"></i>
        } Kaydet
      </button>
      } @else {
      <button
        type="button"
        class="btn btn-secondary"
        (click)="isSettingsPopupVisible = false"
      >
        Kapat
      </button>
      }
    </div>
  </div>
</flexi-popup>
